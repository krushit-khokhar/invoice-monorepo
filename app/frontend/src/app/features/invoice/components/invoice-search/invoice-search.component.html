<div class="invoice-search-container">
  <form [formGroup]="searchForm" class="search-form">
    <!-- Search Input -->
    <div class="search-field">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Search invoices</mat-label>
        <input 
          matInput 
          formControlName="search" 
          placeholder="Search by invoice number, from name, to name..."
          type="search">
        <mat-icon matSuffix>search</mat-icon>
        <button 
          mat-icon-button 
          matSuffix 
          *ngIf="searchForm.get('search')?.value"
          (click)="searchForm.get('search')?.setValue('')"
          type="button"
          aria-label="Clear search">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>
    </div>

    <!-- Advanced Filters Toggle -->
    <div class="advanced-toggle">
      <button 
        mat-button 
        type="button"
        (click)="toggleAdvancedFilters()"
        color="primary">
        <mat-icon>{{ showAdvancedFilters ? 'expand_less' : 'expand_more' }}</mat-icon>
        Advanced Filters
        <span *ngIf="getActiveFilterCount() > 0" class="filter-badge">
          {{ getActiveFilterCount() }}
        </span>
      </button>
    </div>

    <!-- Advanced Filters -->
    <div class="advanced-filters" *ngIf="showAdvancedFilters">
      <!-- Date Range Filter -->
      <div class="filter-group">
        <h4>Date Range</h4>
        <div class="date-filters">
          <mat-form-field appearance="outline" class="date-field">
            <mat-label>From Date</mat-label>
            <input matInput [matDatepicker]="startPicker" formControlName="start_date">
            <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="date-field">
            <mat-label>To Date</mat-label>
            <input matInput [matDatepicker]="endPicker" formControlName="end_date">
            <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
          </mat-form-field>

          <button 
            mat-icon-button 
            color="warn" 
            (click)="onDateRangeClear()"
            *ngIf="searchForm.get('start_date')?.value || searchForm.get('end_date')?.value"
            matTooltip="Clear date range"
            type="button">
            <mat-icon>clear</mat-icon>
          </button>
        </div>
      </div>

      <!-- Name Filters -->
      <div class="filter-group">
        <h4>Specific Names</h4>
        <div class="amount-filters">
          <mat-form-field appearance="outline" class="name-field">
            <mat-label>From Name</mat-label>
            <input matInput formControlName="from_name" placeholder="Filter by sender name">
          </mat-form-field>

          <mat-form-field appearance="outline" class="name-field">
            <mat-label>To Name</mat-label>
            <input matInput formControlName="to_name" placeholder="Filter by recipient name">
          </mat-form-field>
        </div>
      </div>

      <!-- Amount Range Filter -->
      <div class="filter-group">
        <h4>Amount Range</h4>
        <div class="amount-filters">
          <mat-form-field appearance="outline" class="amount-field">
            <mat-label>Min Amount</mat-label>
            <input 
              matInput 
              type="number" 
              formControlName="min_amount" 
              placeholder="Minimum amount"
              min="0"
              step="0.01">
            <span matPrefix>₹&nbsp;</span>
          </mat-form-field>

          <mat-form-field appearance="outline" class="amount-field">
            <mat-label>Max Amount</mat-label>
            <input 
              matInput 
              type="number" 
              formControlName="max_amount" 
              placeholder="Maximum amount"
              min="0"
              step="0.01">
            <span matPrefix>₹&nbsp;</span>
          </mat-form-field>
          <button 
            mat-icon-button 
            color="warn" 
            (click)="onAmountRangeClear()"
            *ngIf="searchForm.get('min_amount')?.value || searchForm.get('max_amount')?.value"
            matTooltip="Clear amount range"
            type="button">
            <mat-icon>clear</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- Sort Options -->
    <div class="sort-options">
      <mat-form-field appearance="outline" class="sort-field">
        <mat-label>Sort by</mat-label>
        <mat-select formControlName="sort_by">
          <mat-option value="invoice_date">Invoice Date</mat-option>
          <mat-option value="invoice_number">Invoice Number</mat-option>
          <mat-option value="from_name">From Name</mat-option>
          <mat-option value="to_name">To Name</mat-option>
          <mat-option value="total_amount">Total Amount</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="order-field">
        <mat-label>Order</mat-label>
        <mat-select formControlName="order">
          <mat-option value="DESC">Descending</mat-option>
          <mat-option value="ASC">Ascending</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Clear Filters Button -->
    <div class="actions">
      <button 
        mat-button 
        color="warn" 
        (click)="onClearFilters()"
        *ngIf="hasActiveFilters()"
        type="button">
        <mat-icon>clear_all</mat-icon>
        Clear All Filters
      </button>
    </div>
  </form>

  <!-- Search Preview -->
  <div class="search-preview" *ngIf="lastSearchParams && hasActiveFilters()">
    <h4>Active Search Parameters:</h4>
    <div class="active-filters">
      <mat-chip-listbox>
        <mat-chip *ngIf="lastSearchParams.search" [removable]="true" (removed)="searchForm.get('search')?.setValue('')">
          Search: "{{ lastSearchParams.search }}"
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        <mat-chip *ngIf="lastSearchParams.start_date" [removable]="true" (removed)="searchForm.get('start_date')?.setValue(null)">
          From: {{ lastSearchParams.start_date | date }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        <mat-chip *ngIf="lastSearchParams.end_date" [removable]="true" (removed)="searchForm.get('end_date')?.setValue(null)">
          To: {{ lastSearchParams.end_date | date }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        <mat-chip *ngIf="lastSearchParams.from_name" [removable]="true" (removed)="searchForm.get('from_name')?.setValue('')">
          Sender: {{ lastSearchParams.from_name }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        <mat-chip *ngIf="lastSearchParams.to_name" [removable]="true" (removed)="searchForm.get('to_name')?.setValue('')">
          Recipient: {{ lastSearchParams.to_name }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        <mat-chip *ngIf="lastSearchParams.min_amount" [removable]="true" (removed)="searchForm.get('min_amount')?.setValue(null)">
          Min: {{ lastSearchParams.min_amount | currency }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
        <mat-chip *ngIf="lastSearchParams.max_amount" [removable]="true" (removed)="searchForm.get('max_amount')?.setValue(null)">
          Max: {{ lastSearchParams.max_amount | currency }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
      </mat-chip-listbox>
    </div>
  </div>
</div>